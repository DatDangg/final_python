{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Thư viện Chart.js -->
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Dashboard</h2>
            </div>
            <ul class="nav-list">
                <li class="nav-item" onclick="showContent('dashboard')">Dashboard</li>
                <li class="nav-item" onclick="showContent('product')">Product</li>
                <li class="nav-item" onclick="showContent('category')">Category</li>
                <li class="nav-item" onclick="showContent('user')">User</li>
                <li class="nav-item" onclick="showContent('order')">Orders</li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard content -->
            <div id="dashboard" class="content active">
                <h1>Dashboard Overview</h1>
                <div class="dashboard-stats">
                    <div class="stat-box">
                        <h3>Total Orders</h3>
                        {% if total_orders %}
                            <p>{{ total_orders }}</p>
                        {% else %}
                            <p>No orders available</p>
                        {% endif %}

                    </div>
                    <div class="stat-box">
                        <h3>Total Sales</h3>
                        <p>${{ total_sales }}</p>
                    </div>
                    <div class="stat-box">
                        <h3>Total Profit</h3>
                        <p>${{ total_profit }}</p>
                    </div>                    
                </div>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <!-- Product content -->
            <div id="product" class="content">
                <h1>Product List</h1>
                <table>
                    <thead>
                        <tr>
                            <th>Số thứ tự</th>
                            <th>Tên sản phẩm</th>
                            <th>Thương hiệu</th>
                            <th>Danh mục</th>
                            <th>Biến thể (Màu, Dung lượng, Giá, Số lượng)</th>
                            <th>Chi tiết</th>
                            <th>Sửa</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% with counter=0 %}
                        {% for product in products %}
                            {% for variant in product.variants.all %}
                            <tr>
                                {% with counter=counter|add:"1" %}
                                <td>{{ counter }}</td>  <!-- Sử dụng biến đếm tùy chỉnh -->
                                <td>{{ product.title }}</td>
                                <td>{{ product.brand }}</td>
                                <td>{{ product.category.name }}</td>
                                <td>
                                    Màu: {{ variant.color }} - Dung lượng: {{ variant.storage }} - 
                                    Giá: {{ variant.listed_price }} - Số lượng: {{ variant.quantity }}
                                </td>
                                <td>
                                    {% if product.phonedetail %}
                                    <ul>
                                        <li>CPU: {{ product.phonedetail.cpu }}</li>
                                        <li>Camera chính: {{ product.phonedetail.main_camera }}</li>
                                    </ul>
                                    {% else %}
                                    No details available
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'edit_product' product.id %}">Sửa</a>
                                </td>                                
                                {% endwith %}
                            </tr>
                            {% endfor %}
                        {% endfor %}
                        {% endwith %}
                    </tbody>
                </table>
            </div>
            
            

            <!-- Category content -->
            <div id="category" class="content">
                <h1>Category List</h1>
                <table>
                    <thead>
                        <tr>
                            <th>Số thứ tự</th>
                            <th>Tên danh mục</th>
                            <th>Hình ảnh</th>
                            <th>Sửa</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category in categories %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ category.name }}</td>
                            <td><img src="{{ category.image.url }}" alt="{{ category.name }}" width="50"></td>
                            <td><a href="{% url 'edit_category' category.id %}">Sửa</a></td>  <!-- Thêm link sửa -->
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Phần quản lý đơn hàng trong dashboard.html -->
<div id="order" class="content">
    <h1>Order Management</h1>
    <table>
        <thead>
            <tr>
                <th>STT</th>
                <th>Tên người đặt</th>
                <th>Số điện thoại</th>
                <th>Địa chỉ</th>
                <th>Tổng tiền</th>
                <th>Trạng thái</th>
                <th>Sửa</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                <td>{{ forloop.counter }}</td> <!-- STT -->
                <td>{{ order.full_name }}</td> <!-- Tên người đặt -->
                <td>{{ order.phone_number }}</td> <!-- Số điện thoại -->
                <td>{{ order.address }}</td> <!-- Địa chỉ -->
                <td>${{ order.total_price }}</td> <!-- Tổng tiền -->
                <td>{{ order.get_status_display }}</td> <!-- Trạng thái -->
                <td>
                    <!-- Form để cập nhật trạng thái đơn hàng -->
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="order_id" value="{{ order.id }}">
                        <select name="status">
                            <option value="pending" {% if order.status == "pending" %}selected{% endif %}>Pending</option>
                            <option value="shipped" {% if order.status == "shipped" %}selected{% endif %}>Shipped</option>
                            <option value="delivered" {% if order.status == "delivered" %}selected{% endif %}>Delivered</option>
                            <option value="cancelled" {% if order.status == "cancelled" %}selected{% endif %}>Cancelled</option>
                        </select>
                        <button type="submit">Sửa</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


            <!-- User content -->
            <div id="user" class="content">
                <h1>User List</h1>
                <table>
                    <thead>
                        <tr>
                            <th>Số thứ tự</th>
                            <th>Tên người dùng</th>
                            <th>Email</th>
                            <th>Ngày tham gia</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.date_joined }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="{% static 'js/dashboard.js' %}"></script>
    {{ sales_data|json_script:"sales-data" }}

    <script>
        var salesData = JSON.parse(document.getElementById('sales-data').textContent);
    
        // Render biểu đồ trong phần dashboard
        var ctx = document.getElementById('salesChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: salesData.map(data => new Date(data.month).toLocaleString('en-US', { month: 'long', year: 'numeric' })),
                datasets: [{
                    label: 'Doanh thu theo tháng',
                    data: salesData.map(data => data.sales),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
    
    {{ sales_data|json_script:"sales-data" }}
    
</body>
</html>
